<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %></title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body class="d-flex justify-content-center align-items-center min-vh-100">
  <div class="card shadow border-eco p-4" style="max-width: 400px; width: 100%;">
    <h1 class="mb-4"><i class="fa-solid fa-user-plus"></i> Registrar Usuario</h1>
    <a href="/" class="btn btn-secondary mb-3">Volver al inicio</a>

    <% if (error) { %>
      <div class="alert alert-danger"><%= error %></div>
    <% } %>

    <form action="/registro" method="POST" class="row g-3">
      <div class="col-md-6">
        <label for="nombre" class="form-label">Nombre completo</label>
        <input type="text" name="nombre" id="nombre" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label for="email" class="form-label">Correo electrónico</label>
        <input type="email" name="email" id="email" class="form-control" required>
      </div>

      <div class="col-md-6">
        <label for="password" class="form-label">Contraseña</label>
        <input type="password" name="password" id="password" class="form-control" required required minlength="6">
        <div id="password-error" class="text-danger"></div>
      </div>

      <div class="col-md-6">
        <label for="rol" class="form-label">Tipo de usuario</label>
        <select name="rol" id="rol" class="form-select" required>
          <option value="">Selecciona...</option>
          <option value="cliente">Cliente</option>
          <option value="productor">Productor</option>
        </select>
      </div>

      <div class="col-12">
        <button type="submit" class="btn btn-eco w-100">Registrarse</button>
      </div>
    </form>
  </div>

  <!-- Script para validar correo existente, contraseña y asi -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const emailInput = document.getElementById('email');
    const form = document.querySelector('form');
    let emailDisponible = false; // estado global

    const emailFeedback = document.createElement('div');
    emailFeedback.classList.add('form-text');
    emailInput.parentNode.appendChild(emailFeedback);

    emailInput.addEventListener('blur', () => {
      const email = emailInput.value.trim();
      if (!email) return;

      fetch(`/verificar-email?email=${encodeURIComponent(email)}`)
        .then(res => res.json())
        .then(data => {
          emailDisponible = data.disponible;
          if (!data.disponible) {
            emailInput.classList.add('is-invalid');
            emailFeedback.textContent = 'Este correo ya está registrado.';
            emailFeedback.classList.remove('text-muted');
            emailFeedback.classList.add('text-danger');
          } else {
            emailInput.classList.remove('is-invalid');
            emailFeedback.textContent = 'Correo disponible.';
            emailFeedback.classList.remove('text-danger');
            emailFeedback.classList.add('text-success');
          }
        });
    });

    form.addEventListener('submit', (e) => {
      if (!emailDisponible) {
        e.preventDefault(); // cancela el envío
        emailInput.focus();
        emailInput.classList.add('is-invalid');
        emailFeedback.textContent = 'No puedes registrarte con este correo.';
        emailFeedback.classList.add('text-danger');
      }
    });
  });
</script>

<!-- Script para validar contraseña de 6 caracteres -->
<script>
  const form = document.querySelector('form');
  const passwordInput = document.getElementById('password');
  const errorDiv = document.getElementById('password-error');

  form.addEventListener('submit', function (e) {
    const password = passwordInput.value.trim();

    if (password.length < 6) {
      e.preventDefault(); // Evita que se envíe el formulario
      errorDiv.textContent = 'La contraseña debe tener al menos 6 caracteres.';
      passwordInput.classList.add('is-invalid');
    } else {
      errorDiv.textContent = '';
      passwordInput.classList.remove('is-invalid');
    }
  });
</script>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
